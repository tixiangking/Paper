\documentclass[english]{cccconf}
%\documentclass[usemulticol,english]{cccconf}
\usepackage[comma,numbers,square,sort&compress]{natbib}
\usepackage{epstopdf}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{stfloats}
\usepackage{bm}
% The preceding line is only needed to identify funding in the first footnote. If that is unneeded, please comment it out.
\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithmic}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xcolor}
\usepackage{algorithm}
\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\begin{document}
	\title{Title}
\title{Clock Synchronization Scheme for Multi-field Manufacturing Systems Using Integrated 5G and TSN Networks
	
\author{San Zhang\aref{sjtu}, Si Li\aref{sjtu}, Wu Wang\aref{sjtu}^*}

% Note: the first argument in the \affiliation command is optional.
% It defines a label for the affiliation which can be used in the \aref
% command. If there is only one affiliation for all authors, then the
% optional argument in the \affiliation command should be suppressed,
% and the \aref command should also be removed after each author in
% \author command, in this case the affiliation will not be numbered.


\affiliation[sjtu]{Department of Automation, Shanghai Jiao Tong University, Shanghai 200240, China}
\affiliation{*E-mail: wangwu@sjtu.edu.cn}  


\maketitle
\maketitle
\begin{abstract}
This article discusses the integration of IEEE 802.1 Time Sensitive Networking (TSN) and fifth-generation (5G) mobile technology in industrial communication networks. Clock synchronization is essential to achieve end-to-end deterministic connections between the two systems. However, current research only considers the simplest case of a single 5G bridge, whereas multiple bridges can increase cumulative synchronization error. To address this issue, the article proposes a clock synchronization scheme, a timestamp compensation scheme, and a carrier spacing optimization scheme for synchronization accuracy. The proposed algorithm is demonstrated through simulation. The paper provides valuable insights for multi-field manufacturing systems scenarios where multiple industrial Ethernet applications may work cooperatively through the 5G network in the time domain.
\end{abstract}

\begin{IEEEkeywords}
IEEE 802.1 Time Sensitive Networking (TSN), fifth-generation (5G), clock synchronization, end-to-end deterministic connection
\end{IEEEkeywords}


\section{Introduction}
Industrial communication networks require high availability, reliability, and low latency. However, traditional industrial Ethernet systems are closed and incompatible with each other(shown in TABLE \uppercase\expandafter{\romannumeral1}). To improve real-time capabilities, the IEEE 802.1 Time Sensitive Network (TSN) standard is widely considered as a long-term substitute for proprietary technology in industrial control systems. Additionally, Industry 4.0 and Factory of Future (FoF) require wireless network access in Ethernet. Nevertheless, traditional wireless networks face problems of large transmission delay and short distance\cite{2013Recommendations}(shown in TABLE \uppercase\expandafter{\romannumeral2}). The fifth generation (5G) mobile/cellular technology, designed to support ultra-reliable low latency communication (URLLC), is expected to meet the strict requirements of industrial systems in the wireless field. Thus, the integrated operation of 5G and TSN systems is crucial to achieving end-to-end deterministic connection in industrial networks.
\begin{table}[htbp]
	\caption{Current Main Ethernet Protocols}
	\begin{center}
		\begin{tabular}{|c|c|c|}
			\hline
			\textbf{Protocol}& \textbf{Organization}& \textbf{Manufacturer} \\
			\hline
			EtherNet/IP
			& ODVA
			& Rockwell \\
			\hline
			PROFINET
			& PROFIBUS
			& Siemens \\
			\hline
			EtherCAT
			& EtherCAT Association
			& Bev \\
			\hline
			POWERLINK
			& EPSG
			& ABB \\
			\hline
			CC-LINK
			& CC-Link Association
			& Mitsubishi \\
			\hline 						
		\end{tabular}
		\label{tab1}
	\end{center}
\end{table}

\begin{table}[htbp]
	\caption{Current Main Wireless Protocols}
	\begin{center}
		\begin{tabular}{|c|c|c|}
			\hline
			\textbf{Protocol}& \textbf{Delay}& \textbf{Transmission Distance} \\
			\hline
			LTE
			& 6ms
			& 400-1000m \\
			\hline
			WIFI
			& 6ms
			& 100-200m \\
			\hline
			Zigbee
			& 1-3ms
			& 10-100m \\
			\hline		
		\end{tabular}
		\label{tab1}
	\end{center}
\end{table}
Clock synchronization is the basis and key of 5G+TSN integration. The 3GPP protocol proposes a bridge architecture synchronization mode based on TSN802.1AS for clock synchronization, but specific synchronization rules and algorithm details are not specified\cite{888888}. Previous research analyzed the impact of various errors that may exist at the junction of the bridge and TSN nodes in the synchronization architecture on the synchronization algorithm\cite{9527833}. Research\cite{9211936} optimized the synchronization packets inside the 5G bridge, reducing communication overhead. Another study has introduced a clock domain compensation technology to estimate the residence time of 5G timing messages\cite{9674640}, and another research work has investigated how synchronization and syntonization errors affect the achievable end-to-end time synchronization accuracy in integrated 5G and TSN networks However, current research only considers the simplest case of a single 5G bridge\cite{9557468}. In future intelligent factories integrated with industrial and 5G networks, multiple industrial Ethernet application scenarios may work cooperatively through the 5G network in the time domain\cite{8402373}(Fig.1). When multiple bridges are present in a system, the cumulative synchronization error can increase. Therefore, this paper proposes the following contributions to address these issues:
\begin{itemize}
	\item we propose a clock synchronization scheme for multi-field manufacturing systems scenarios.
	\item we propose a timestamp compensation scheme for multi-hop synchronization errors in multi-field manufacturing systems scenarios.
	\item we propose a carrier spacing optimization scheme for synchronization accuracy in 5G+TSN clock synchronization.
\end{itemize}
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{0}
	\includegraphics[width=3in]{fig11.png}
	\caption{Multi-field Manufacturing Systems Scenarios}
	% \label{fig_sim}
\end{figure}

The paper is structured as follows: In Chapter \uppercase\expandafter{\romannumeral2}, we analyze the clock model and error model. In Chapter \uppercase\expandafter{\romannumeral3}, we propose a hybrid synchronous architecture that uses 5G+TSN as the core network to address the synchronization needs of multi-field manufacturing systems scenarios. In Chapter \uppercase\expandafter{\romannumeral4}, we optimize the cumulative error in the synchronization process by carrier spacing optimization and timestamp compensation. In Chapter \uppercase\expandafter{\romannumeral5}, we demonstrate the algorithm's effect through simulation.

\section{Model}

\subsection{Clock Model}
The complexity of the industrial site can significantly affect the crystal oscillator of the device clock, leading to deviations in the initial clock state and rate of change, resulting in clock errors. Specifically, the clock of a node can be expressed as:
\begin{equation}
	C_i(t) = (\alpha _i+\sigma_i)t + \beta _i +\delta_i
\end{equation}
where $\alpha_i$ and $\beta_i$ are the estimated time-varying clock skew and constant clock offset to the reference clock, and $\sigma_i$ and $\delta_i$ are the errors in the estimation of the frequency and time differences. Ideally, $\alpha_i = 1$ and $\beta_i = 0$. The change in slope arises from the drift of the internal crystal oscillator of the clock, while the difference in the initial state results from errors during network initialization. The crystal frequency of the clock is affected by various factors, such as temperature, voltage, and aging degree, among others.

In the 5G-TSN bridge structure (as shown in Fig.2), 5G and TSN networks operate in different time domains. Therefore, for the current bridge structure combined with 5G and TSN, the clock model of the TSN time domain can be expressed as:
\begin{equation}
	C_{TSN}(t) = (\alpha_{TSN}+\sigma_{TSN})t + \beta _{TSN} +\delta_{TSN}
\end{equation}
 correspondingly, the clock model of the 5G part can be expressed as:
 \begin{equation}
 	C_{5G}(t) = (\alpha_{5G}+\sigma_{5G})t + \beta _{5G} +\delta_{5G}
 \end{equation}
in these equations, $\alpha_{TSN}$ and $\sigma_{TSN}$ represent the frequency synchronization correction estimate and error on the wired side, respectively. Similarly, $\alpha_{5G}$ and $\sigma_{5G}$ represent the frequency synchronization correction estimate and error on the wireless side. $\beta_{TSN}$ and $\delta_{TSN}$ represent the time bias synchronization correction estimate and error on the wired side, while $\beta_{5G}$ and $\delta_{5G}$ represent the estimated value and error of the time-bias synchronization correction on the wireless side. 

In the given equations, it is assumed that the synchronization errors $\sigma_{TSN}$ and $\delta_{TSN}$ are much smaller than those of the 5G network, $\sigma_{5G}$ and $\delta_{5G}$. Typically, the synchronization accuracy of the 5G network is at the microsecond level, while that of the TSN network is at the nanosecond level. Hence, when timestamps pass through the bridge, there are bound to be timestamp errors. These errors are usually acceptable when only one bridge is present, but in scenarios where there are multiple bridges in the network, the errors accumulate and significantly impact clock synchronization. These timestamp errors impact synchronization accuracy by affecting the measurement of delay during clock synchronization. Therefore, in order to address these errors, we need to model and analyze the delay.
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{1}
	\includegraphics[width=3.5in]{fig12.png}
	\caption{5G-TSN Bridge}
	% \label{fig_sim}
\end{figure}
\subsection{Delay Model}
In the process of synchronization, in addition to the accuracy of the clock, the delay between nodes is an important factor that affects synchronization accuracy. In the network bridge structure, the 5G network bridge is composed of all 5G wireless nodes that relay the signal. Therefore, the transmission delay between the internal nodes of the 5G network determines the transmission delay of the network bridge, thereby affecting the clock synchronization accuracy of the TSN devices at both ends. Typically, the delay can be expressed as:
\begin{equation}
	Delay=D_d+D_r
\end{equation}
where $D_d$ is the deterministic delay, mostly composed of transmission delay that can be measured or eliminated. On the other hand, $D_r$ is the random delay, mostly composed of propagation delay jitter and cumulative error. While propagation delay jitter can be periodically measured to reduce its effect on synchronization accuracy\cite{9064350}, accumulated errors may have a significant impact on clock synchronization accuracy in large-scale networks. To analyze the specific effects of accumulated error, it is necessary to model the queuing delay.
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{2}
	\includegraphics[width=3.5in]{fig3.png}
	\caption{the Internal Synchronization Mode of 5G }
	% \label{fig_sim}
\end{figure}
The internal synchronization mode of the 5G network is illustrated in Fig.3, where 5G wireless nodes synchronize by receiving Sync messages from the base station. When multiple nodes synchronize with the same base station simultaneously, queuing delay occurs. To calculate the expected value of the queuing delay, the queue generated by the non-clock-synchronous traffic arriving in batches at the switch is computed first, and the expected value of the series is obtained by calculating the generating function of the series. Then, the queue delay of the clock-synchronous flow in the presence of background traffic is analyzed to obtain the expected length of the queue. The calculation of background traffic adopts the non-preemptive consideration, which is more in line with the actual situation. Both the non-clock synchronous traffic queue and clock-synchronous traffic queue are modeled, and queuing theory is used to model and solve the Markov chain. The steady-state equation listed according to the Markov chain is:

\begin{equation*}
	p_i\left( \lambda +i\cdot \mu \right) =\sum_{j=0}^i{p_j\cdot \lambda \cdot a_{i-j}+p_{i+1}\left( i+1 \right) \cdot \mu\,\, 0\leqslant i<m}
\end{equation*}
\begin{equation}
	p_i\left( \lambda +m\cdot \mu \right) =\sum_{j=0}^i{p_j\cdot \lambda \cdot a_{i-j}+p_{i+1}m\cdot \mu}\,\, m\leqslant i
\end{equation}
where $p_i$ is the probability of there being $i$ packets in the queue, $m$ is the maximum queue value, $\lambda$ is the total packet arrival rate, $\mu$ is the packet processing rate, and $a$ is the distribution of the number of packets arriving.And $c=\mu/\lambda $.We assume that when $k$ packets arrive at the base station, there are $v$ non-clock synchronous packets in the system. There can be three cases:
\begin{itemize}
	\item Case 1: $v<m$,$k<m-v$, QueueLength = 0.
	\item Case 2: $v<m$,$k>m-v$, QueueLength = $k+v-m$.
	\item Case 3: $v>m$, QueueLength = $k$.
\end{itemize}

Based on these three cases, the expected value of queuing delay can be obtained by solving the Markov chain and summing with the full probability formula.
\begin{equation*}
	L_q=P_0\cdot \sum_{i=0}^m{\left(k-m+i\right)\cdot \frac{\left(\lambda/\mu\right)^i}{i!}+P_0\cdot \frac{k-m}{m!}\cdot \frac{\rho^m}{v!\left(1-\rho^m\right)}}
\end{equation*}
\begin{equation}
	\rho=\frac{\lambda}{\mu}
\end{equation}

According to the 5G protocol standard 3GPP TS 22.104 for large-scale application scenarios (3GPP, 2020), the upper limit of synchronization nodes in a single time domain is 100 when the service area is between 10 and 20 $km^2$\cite{888889}. By substituting these conditions into the queuing delay model, we can ensure that the queuing delay is less than 250 ns. Given the required synchronization accuracy of $1\mu s$, we can assume that the random queuing delay has a negligible influence on the synchronization accuracy, and that only the fixed delay impacts synchronization accuracy. Therefore, our timestamp compensation for multi-field manufacturing systems scenarios can focus solely on the effect of fixed delay on clock synchronization under these conditions.

\section{Synchronization Architecture}
\subsection{Network Structure}
To address multi-field manufacturing system scenarios, we have designed a synchronization architecture for heterogeneous networks. This architecture involves dividing the industrial Ethernet network into different wired islands based on the clock model's different time-domain models. The 5G network acts as a bridge between these wired islands. In 3GPP, two main clock models are considered for time synchronization in integrated 5G and TSN systems, both of which comply with the IEEE 802.1AS standard. These models include the boundary clock and the transparent clock\cite{9615318}.

In the boundary clock solution, the 5G Radio Access Network (RAN) has direct access to the TSN master clock, providing timing information to user equipment (UE) through its own signaling and procedures. UE synchronizes TSN devices based on periodic information. In contrast, the transparent clock solution achieves time synchronization by exchanging PTP messages, where any intermediate 5G or TSN entity between the TSN main console and the TSN device will update the PTP message to update the time spent in the entity.

Therefore, 5G networks serve as transparent clocks, while wired networks serve as boundary nodes. The 5G RAN has direct access to the TSN Master Time, either through a direct connection to the TSN master clock or through an underlying transport network that supports PTP, which can reduce the transmission overhead of TSN timestamps in 5G networks.

To meet the requirements of assumptions and communication protocols, the number of wireless nodes in each network bridge should not exceed 100. When the number of nodes exceeds this number, a new boundary node will be established to split the network bridge. Figure 3 shows the overall architecture diagram.
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{3}
	\includegraphics[width=3.5in]{fig17.png}
	\caption{Schematic of slot allocation in the TAS model}
	% \label{fig_sim}
\end{figure}
\subsection{Synchronization Mechanism}
To synchronize the wired part, we adopt the GPTP synchronization scheme, while broadcast synchronization completes the synchronization of the wireless part. The accuracy of the synchronization within the 5G bridge affects the precision of the time calculation when the timestamp passes through the transparent clock. To synchronize the clock of a multi-hop large-scale wireless network node inside the 5G-TSN bridge, we first need to determine the hierarchy of each node, which forms the basis for locating each wireless node.

The root node initiates the synchronization message with a count of $k=0$, and the receiving node sets the count to $k+1$ and sends the broadcast synchronization message containing $k+1$ to the next level. To minimize energy consumption and reduce computational complexity while maintaining synchronization accuracy, we adopt the mechanism of inverse synchronization for the asymmetric network clock synchronization characteristics of the TSN+5G network\cite{8935413}. Timestamp conversion involves floating-point division, which needs to be performed at the TSN end since it has more computational resources.

Specifically, the 5G nodes periodically launch synchronization request messages to the TSN switches of the edge nodes at both ends. The slave clock receives the reference timestamp $G$ from the master clock through several intermediate ones and records the local time $L$, which are then sent to the TSN nodes. The TSN node performs a linear regression process to estimate the frequency difference and clock deviation after exchanging several sets of timestamps. The intermediate forwarding node is treated as a transparent clock.

Finally, the correction time of each wireless node can be expressed as follows:
Please find below the proofread text:

The correction time of each wireless node can be expressed as:
\begin{equation}
	\widehat{L}=L\left(1+\frac{\widehat{\alpha}}{f_0}\right)-\widehat{\beta}+\left[\frac{G_0-L_0}{T_c}\right] T_c
\end{equation}
where $\widehat{\alpha}$ represents the estimation of frequency difference, and $\widehat{\beta}$ is the estimation of clock deviation.The term $[\frac{G_0-L_0}{T_c}] T_c$ represents the transmission delay from the 5G network node to the TSN node. $T_c$ represents the time slot of the 5G network and is the upper limit of accuracy that can be achieved by estimating the transmission delay during the 5G-TSN clock synchronization. This forms the basis for the subsequent synchronization accuracy optimization scheme.
\section{Synchronization Error}

\subsection{Optimization}
According to Equation (7), the upper limit of error for estimating transmission delay during 5G-TSN synchronization in 5G networks is known to be $T_c/2$. As shown in Figure 5, the frame structure of 5G networks consists of a wireless frame and a subframe of the same length, which are 10ms and 1ms, respectively. Each time slot in 5G contains 14 OFDM symbols, with 4 OFDM symbols occupied by SSBS (clock synchronization messages). The duration and period of SSBS vary with different subcarrier intervals, and the interval of 5G subcarriers can be adjusted. By utilizing the distributable property of the subcarrier interval in 5G networks, the number of subcarriers and the symbol length of OFDM can be reduced by increasing the subcarrier interval, thereby reducing delay and cumulative error. From these protocols we can obtain Equation 8:
\begin{equation}
	\begin{split}
		&T_{c}=\frac{15kHz}{\triangle F}\\
		&\triangle F=2^\mu\cdot15kHz \\
	\end{split}	
\end{equation}
where $\triangle F$ is the sub-carrier spacing (SCS), $\mu=\{0,1,2,3,4,5\}$. It shows that when the carrier frequency $f_c$ is fixed, increasing the sub-carrier spacing $\triangle F$ decreases clock synchronization errors $\varepsilon$.

However, increasing the carrier spacing can also cause the following problems:
\begin{itemize}
	\item reduced spectral efficiency: the larger the carrier interval, the smaller the amount of data that can be transmitted on each carrier, and the lower the spectral efficiency.
	
	\item reduced anti-interference capability: the larger the carrier spacing, the larger the channel width, and the larger the BER when encountering interference sources.
	
	\item increased power consumption: if the BER(Bit Error Rate) is to be guaranteed low, the signal power needs to be enhanced, which will lead to increased power consumption.
	
	\item waste of resources: a large carrier spacing may cause some spectrum resources to be wasted.
\end{itemize}
Choosing an appropriate carrier spacing is crucial for achieving high-precision 5G+TSN synchronization. This problem can be reduced to a trade-off between synchronization accuracy and bandwidth utilization, which can be expressed as:
\begin{equation}
	\eta=\frac{12\cdot N_{RB}\cdot \triangle F}{B}
\end{equation}
where $N_{RB}$ is the number of RBs, and $B$ is the network's bandwidth. To find the optimal carrier spacing, an optimization problem can be constructed as follows:
\begin{equation}
	\begin{split}
		&\min_{\triangle F} \,\, \omega_1 \cdot T_c+\omega_2 \cdot \frac{1}{\eta} \\
		&s.t.\quad  \left\{\begin{array}{lc}
			T_{cmin}\leq T_c \leq T_{cmax}\\
			B_{min}\leq B \leq B_{max}\\
			N_{RB}\leq 273\\
		\end{array}\right.
	\end{split}
\end{equation}
where $\omega_1$ and $\omega_2$ represent the weights of synchronization accuracy and bandwidth utilization, respectively. Users can assign their weights according to their needs. This method minimizes synchronization errors without significantly impacting the original communication quality of the 5G network.
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{4}
	\includegraphics[width=3in]{fig14.png}
	\caption{5G Carrier Structure}
	% \label{fig_sim}
\end{figure}
\subsection{Compensation}
When multiple bridges are connected to each other in the network, as shown in Fig.1, the cumulative error will be further amplified, and the timestamp needs to be compensated and corrected. At each point where the Time-Sensitive Networking (TSN) network intersects with the 5G network, the synchronization process can be represented as in Fig.5. The TSN time domain at both ends can be abstracted as master-slave nodes. According to equations 2 and 3, the local time of the wired and wireless sides can be expressed as:
\begin{eqnarray}
	\begin{aligned}
		&t_{(\text {wired})}=\left(\alpha_{TSN}+\sigma_{TSN}\right) t+\beta_{TSN}+\delta_{TSN}\\
		&t_{(\text {wireless })}=\left(\alpha_{5G}+\sigma_{5G}\right) t+\beta_{5G}+\delta_{5G}\\
	\end{aligned}
\end{eqnarray}
Due to differences in the accuracy of time bias and frequency estimation on both sides, clock synchronization between wired and wireless timestamp exchanges can cause boundary synchronization errors.When the left wired master clock sends a sync message containing a timestamp of time $t_1$, the corresponding reference time should be $t_1^{ref}$. When this message arrives on the wireless side, the node will receive and record the timestamp $t_2$. The timestamp values can be expressed as follows:
\begin{equation}
	\begin{split}
		&t_{2}=(t_1^{ref}+delay)(\alpha_{5G}+\sigma_{5G})+\beta_{5G}+\delta_{5G} \\
		&t_1^{ref}=\frac{t_{1}-\beta_{TSN}-\delta_{TSN}}{\alpha_{TSN}+\sigma_{TSN}}
	\end{split}
\end{equation}
similarly, on the wireless network side, the node records the timestamp $t_3$ upon receiving the $Sync$ message and sends the  $Delay\_Req$ message. Subsequently, the wired network node records the timestamp $t_4$ after receiving  $Delay\_Req$. The values of the timestamps can be expressed as:
\begin{equation}
	\begin{split}
		&t_{4}=(t_3^{ref}+delay)(\alpha_{TSN}+\sigma_{TSN})+\beta_{TSN}+\delta_{TSN} \\
		&t_3^{ref}=\frac{t_{3}-\beta_{5G}-\delta_{5G}}{\alpha_{5G}+\sigma_{5G}}
	\end{split}
\end{equation}
thus the transmission delay between the two network nodes can be expressed as:
\begin{equation}
	\begin{split}
		&2  delay =t_{2}-t_{1}+t_{4}-t_{3} \\
		&=m\left(t_{2}-t_{1}+t_{4}-t_{3}\right)-(m-1 / m)\left(\beta_{TSN}+\delta_{TSN}\right)\\
		&\quad+(m-1 / m)\left(\beta_{5G}+\delta_{5G}\right)\\
		& \approx m\left(t_{2}-t_{1}+t_{4}-t_{3}\right)-(m-1 / m)\left(\beta_{5G}+\delta_{5G}\right)\\
		&m=\frac{\alpha_{5G}+\sigma_{5G}}{\alpha_{TSN}+\sigma_{TSN}}		
	\end{split}
\end{equation}
in equation 14, the synchronization error of the wired part is much smaller than that of the wireless part and is therefore neglected. It is important to note that the calculation of the timestamp and clock parameters should be performed on the side of the wired network (i.e., the TSN node), and then the result should be sent to the 5G network node via the $Delay\_Resp$ message. The synchronization algorithm involves floating-point division, and because TSN network nodes have higher accuracy in floating-point calculation, these calculations should be performed by the head (TSN) part. This can effectively improve synchronization accuracy and reduce the computational complexity of 5G nodes.

\begin{figure}[htbp]
	\centering
	\setcounter{figure}{5}
	\includegraphics[width=2in]{fig10.png}
	\caption{Synchronization process}
	% \label{fig_sim}
\end{figure}
\section{Simulation Results}
Based on our proposed synchronization architecture and model above, numerical simulations were performed to evaluate the performance of the optimization and compensation schemes. First, we tested the values of synchronization accuracy at different SCSs. According to the numerology setting of 5G NR system\cite{access2015requirements}, the maximum SCS $\triangle F_{max}$ is 480 kHz and the FFT(Fourier transform) size is 4096, thus conducting to a time unit covering 0.509 ns. We set the drift of the 5G internal UE clock compared to the gNB clock,$\alpha_{5G}/\alpha_{TSN}$, to 10 ppm (10 ns per millisecond).
Based onn the literature [3], it is proposed that in the intelligent factory integrated with the industrial network and 5G network in the future, there are multiple industrial Ethernet application scenarios that work cooperatively through the 5G network in the time domain. So we proposed a general simulation scenario, shown in Fig. 5, models the cooperative interaction of several mobile robots. A typical use case for future factories, that requires precise time synchronization of sevaral wired networks across wireless links.

\subsection{Single-hop Simulation}

but there is a limit to the accuracy improvement, and converges to a fixed value when $\Delta$ tends to 0.

Single-hop synchronization is implemented in matlab for baseband simulation, not involving RF content, the receiver input signal rxWaveform has been IQ road data, SSB can only be in the synchronization grid, synchronization grid is used to configure the basic frequency location of the synchronization / broadcast signal, is an absolute frequency. rxWaveform can also be understood as the receiver has been from the synchronization grid this frequency The baseband data obtained after down-converting to baseband and completing A/D sampling, the baseband data is determined by a series of algorithms to determine if there is an SSB synchronization block inside this data. If there is, it means that there is a synchronization block in this synchronization grid, and it has been found, and the MIB is recovered. The synchronization method is set to "time-frequency two-dimensional search" according to the 5G protocol, and the coarse frequency bias estimation and determination of NID2 is done by traversing the three cases of NID2. matlab5G toolbox is set to 1/2*scs for the search step, because the range that can be estimated by the CP-based CFO estimation technique is the subcarrier interval multiplied by [-0.5,0.5), and this technique cannot be used to estimate integer multiplicative frequency bias. So the frequency spacing error needs to be estimated to within the subcarrier spacing times [-0.5,0.5) before the CP-based CFO estimation technique can be used.
Then, after that, we will not use 1/2*scs but choose 15khz to compare the accuracy of the frequency difference estimation.
For channel equalization at low carrier spacing, MMSE equalization, which is a ZF equalizer that takes into account the noise, will be used here, assuming that the transmitter sends a guide sequence x = [1,1,1,1,1,1], [1,1,1,1,1] arrives at the receiver after passing through the channel, which is assumed to be called y. The receiver compensates by the y already received, and the H already obtained by channel estimation before this, to the effect of the channel on the signal, thus recovering x more efficiently.

The simulation experimental results are shown in Fig. 5 and Fig. 6. The synchronization errors at different carrier intervals are shown in Fig. 5, and the BER at low carrier intervals after equalizer compensation is shown in Fig. 6.As shown in the figure, the synchronization accuracy is significantly improved with low carrier spacing and with equalizer compensation.
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{6}
	\includegraphics[width=3in]{fig6.png}
	\caption{frequency offset at different carrier intervals}
	% \label{fig_sim}
\end{figure}
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{8}
	\includegraphics[width=3in]{fig8.png}
	\caption{BER before equalizer compensation}
	% \label{fig_sim}
\end{figure}
\begin{figure}[htbp]
	\centering
	\setcounter{figure}{9}
	\includegraphics[width=3in]{fig9.png}
	\caption{BER after equalizer compensation}
	% \label{fig_sim}
\end{figure}
\subsection{Multihop Simulation}
We model each mobile robot as a TSN endstation, connected to a 5G UE via a variable number of TSN Bridges (here: transparent clocks). Every device, both TSN and 5G, is based on the omnet Node class. For every node, a clock instance according to section III clock modle. The rest of the setup differs between TSN and 5G devices:
The TSN nodes are connected using the Carrier Sense Multiple Access (CSMA) channel model. ns-3 does not provide a real ethernet model, however the CSMA channel model supports layer 2 communication and is a sufficiently close approximation of ethernet for our purpose.
\begin{itemize}
	\item The gPTP procedures are defined in a separate class and installed on each node. We differentiate between ordinary and transparent clocks. This determines how a node interacts with the different gPTP messages. Every TSN node will initiate the peer delay messaging process to its neighbors. Only the ordinary clock acting as the master clock will initiate the synchronization messaging process.
	\item The 5G devices have to act as a gateway between the TSN and 5G networks. To achieve that, they are made up of two nodes. One node is connected to the CSMA channel and acts as the wired (ethernet) port. The other node acts as the 5G module and is connected to the wireless channel. Both nodes share the same local clock instance and essentially act as one device. The TSN translator functionalities are also defined in a separate class and installed on these 5G nodes.
	
	The 5G internal communication uses the 5G LENA module [16]. This module focuses on the PHY and MAC layers, based on the 3GPP Rel. 15 non-standalone version of 5G. Higher layers reuse the existing LENA lte module.
	
	The 5G LENA module provides a wireless channel implementation and supports different frame structures and frequency bands. For the 5G-internal traffic, UDP/IP communication is used. The specific configuration setup used for our 5G LENA implementation is given in Table
\end{itemize}


\bibliography{cx.bib}
\bibliographystyle{IEEEtran}
\end{document}
